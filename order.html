<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Order Details</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.0/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sometype+Mono:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">
    <style>
        .chakra-input.css-dni0pk {
            font-family: "Sometype Mono", monospace;
            font-optical-sizing: auto;
            font-weight: 400;
            font-style: normal;
            font-size: 17px; /* Adjust the font size if needed */
        }
        
        .body { 
            height: 100vh;
        }
        .needed {
            height: 1000px;
        }
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            z-index: 9999;
            overflow-y: scroll;
        }
        .popup h2 {
            margin: 0 0 10px;
        }
        .popup p {
            margin: 5px 0;
        }
        .popup button {
            margin-top: 15px;
            padding: 10px 15px;
            background-color: #28a745;
            border: none;
            color: #fff;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
        }
        .popup button:hover {
            background-color: #218838;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

    </style>
</head>
<body class="needed">
    <nav class="navbar">
        <!-- Logo linked to index.html -->
        <a href="index.html" class="logo">
            <img src="realcalilogo copy.png" alt="Logo">
        </a>
        <!-- Text logo, if needed -->
        <div class="logotext">
            <img src="logotextreal.png" alt="Logo Text">
        </div>
    </nav>
    <div class="overlay" id="overlay"></div>

    <div class="popup" id="order-popup">
        <h2 style="padding: 10px;">Products</h2>
        <div id="order-items"></div>
        <div class="summary">
        <h2>Order Details</h2>
        <h3>Order Id: <span id="orderId"></span></h3>
        <p><strong>Delivery Address:</strong> <span id="popup-address"></span></p>
        <p><strong>Name:</strong> <span id="popup-date"></span></p>
        <p><strong>Contact Info:</strong> <span id="popup-contact"></span></p>
        <p><strong>Comments:</strong> <span id="popup-comments"></span></p>

        <h3><strong><span id="subtotal"></span></strong></h3>
        <button id="confirm-order-btn">Confirm Order</button>
    </div>
    </div>

    <div class="sections">
        <div class="section-block">
            <div class="container">
                <div class="back-button">
                    <a href="javascript:history.back()">
                        &#9664; Back
                    </a>
                </div>
    
                <div id="product-name"></div>
                 <!-- Order Summary Section -->
                 <div id="order-summary" class="order-summary" style="display:none;">
                    <h1>Order Summary</h1>
                    <div id="order-summary-details"></div>
                    <button id="confirm-order-button" class="submit-button">Confirm Order</button>
                </div>
            </div>
        </div>
    </div>

            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.0/mapbox-gl.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script>document.addEventListener('DOMContentLoaded', function() {
function getUrlParameter(name) {
    name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
    const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    const results = regex.exec(location.search);
    return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' ')) || '';
}
let items = [];
let cartItems;





function getCartItemsFromUrl() {
    let items = [];
    let index = 0;

    while (true) {
        const itemId = getUrlParameter(`id-${index}`);
        if (!itemId) break; // Exit loop if no more items
        const name = decodeURIComponent(getUrlParameter(`name-${index}`))
        const quantity = parseInt(getUrlParameter(`quantity-${index}`), 10) || 1;
        const type = getUrlParameter(`type-${index}`);
        const pricePerGram = parseFloat(getUrlParameter(`pricePerGram-${index}`)) || 0;
        const pricePerOz = parseFloat(getUrlParameter(`pricePerOz-${index}`)) || 0;
        const pricePerQp = parseFloat(getUrlParameter(`pricePerQp-${index}`)) || 0;
        const pricePerHalfP = parseFloat(getUrlParameter(`pricePerHalfP-${index}`)) || 0;
        const pricePer1Lb = parseFloat(getUrlParameter(`pricePer1Lb-${index}`)) || 0;
        const description = getUrlParameter(`description-${index}`);
        const price = getUrlParameter(`price-${index}`);
        const bulkPrices = decodeURIComponent(getUrlParameter(`bulkprices-${index}`));
        let bulkPricesObj = {};
        try {
            bulkPricesObj = JSON.parse(bulkPrices); // Convert the JSON string to an object
        } catch (e) {
            console.error('Error parsing bulk prices:', e);
            bulkPricesObj = {}; // Set as empty object if parsing fails
        }
        console.log(bulkPricesObj)

        items.push({
            id: itemId,
            quantity: quantity,
            type: type,
            pricePerGram: pricePerGram,
            pricePerOz: pricePerOz,
            pricePerQp: pricePerQp,
            pricePerHalfP: pricePerHalfP,
            pricePer1Lb: pricePer1Lb,
            description: description,
            price: price,
            bulkPrices: bulkPricesObj,
            name:name // Include the bulk prices object
        });

        index++;
    }
    return items;
}


function calculateTotalPrice(cartItems) {
    let totalPrice = 0;

    cartItems.forEach(item => {
        let pricePerUnit;
        let unitPrice = 0;

        // Determine price per unit based on item type
        if (item.type === 'piece') {
            unitPrice = parseFloat(item.price) || 0;
        } else {
            switch (item.type) {
                case 'grams':
                    unitPrice = parseFloat(item.pricePerGram) || 0;
                    break;
                case 'oz':
                    unitPrice = parseFloat(item.pricePerOz) || 0;
                    break;
                case 'qp':
                    unitPrice = parseFloat(item.pricePerQp) || 0;
                    break;
                case 'half-pound':
                    unitPrice = parseFloat(item.pricePerHalfP) || 0;
                    break;
                case 'lbs':
                    unitPrice = parseFloat(item.pricePer1Lb) || 0;
                    break;
                default:
                    unitPrice = 0;
            }
        }

        // Get bulk price if applicable
        if (item.bulkPrices ) {
            let applicablePrice = 0;

            // Find the correct bulk price based on quantity
            Object.keys(item.bulkPrices).forEach(quantityThreshold => {
                if (item.quantity >= quantityThreshold) {
                    applicablePrice = parseFloat(item.bulkPrices[quantityThreshold]);
                }
            });

            // If an applicable bulk price is found, use it
            if (applicablePrice > 0) {
                pricePerUnit = applicablePrice;
            } else {
                pricePerUnit = unitPrice;
            }
        } else {
            pricePerUnit = unitPrice;
        }

        // Accumulate the total price
        totalPrice += pricePerUnit * item.quantity;
    });

    return totalPrice;
}

function updateTotalPrice(cartItems) {
    const totalPrice = calculateTotalPrice(cartItems);
    document.getElementById('total-price').textContent = `Total Price: $${totalPrice.toFixed(2)}`;
}

    
        const isCartPage = location.search.includes('id-');
        const isSingleProductPage = location.search.includes('productDescription');
    
        if (isCartPage) {
    cartItems = getCartItemsFromUrl();
    const section = document.querySelector('.section-block');

    if (isCartPage) {
    const cartItems = getCartItemsFromUrl();
    const section = document.querySelector('.section-block');

    if (cartItems.length > 0) {
    const cartSummary = document.createElement('div');
    cartSummary.classList.add('cart-summary');
    section.appendChild(cartSummary);

    const totalPriceElement = document.createElement('p');
    totalPriceElement.id = 'total-price';
    cartSummary.appendChild(totalPriceElement);

    cartItems.forEach((item, index) => {
        const itemContainer = document.createElement('div');
        itemContainer.classList.add('item-container');
        section.appendChild(itemContainer);

        const itemTitle = document.createElement('h2');
        itemTitle.textContent = `Product Name: ${item.name}`;
        itemContainer.appendChild(itemTitle);

        const itemDescription = document.createElement('p');
        itemDescription.textContent = `Description: ${item.description}`;
        itemContainer.appendChild(itemDescription);

        const quantityInput = document.createElement('input');
        quantityInput.type = 'number';
        quantityInput.classList.add('quantity');

        quantityInput.value = item.quantity;
        itemContainer.appendChild(quantityInput);

        const quantityUnitSelect = document.createElement('select');
        quantityUnitSelect.classList.add('custom-select');
        const units = [
            { value: 'grams', text: `Grams - $${item.pricePerGram.toFixed(2)}`, price: item.pricePerGram },
            { value: 'oz', text: `Ounces (oz) - $${item.pricePerOz.toFixed(2)}`, price: item.pricePerOz },
            { value: 'qp', text: `Quarter Pound (QP) - $${item.pricePerQp.toFixed(2)}`, price: item.pricePerQp },
            { value: 'half-pound', text: `Half Pound - $${item.pricePerHalfP.toFixed(2)}`, price: item.pricePerHalfP },
            { value: 'lbs', text: `Pounds (lbs) - $${item.pricePer1Lb.toFixed(2)}`, price: item.pricePer1Lb },
            { value: 'piece', text: `Piece - $${item.price}`, price: item.price }
        ];

        units.forEach(unit => {
    // Only add options for units with a non-zero price or if it is the default type
    if (unit.price > 0 || unit.value === item.type) {
        const option = document.createElement('option');
        option.value = unit.value;
        option.textContent = unit.text;

        // Set data attributes
        option.dataset.price = unit.price;
        option.dataset.value = unit.value;
        // Add other data attributes as needed

        quantityUnitSelect.appendChild(option);
    }
});

        // Determine default value
        let defaultValue = item.type;

        // Check if the item type exists in the units array and get its price
        const selectedUnit = units.find(unit => unit.value === item.type);
        console.log(item.type)
        if (item.type === 'unknown' ){
            defaultValue = 'piece';
        }

        quantityUnitSelect.value = defaultValue;

        itemContainer.appendChild(quantityUnitSelect);

        // Add comment section for each product
        const commentSection = document.createElement('div');
        commentSection.classList.add('comment-section');
        const commentLabel = document.createElement('label');
        commentSection.appendChild(commentLabel);

        const commentTextArea = document.createElement('textarea');
        commentTextArea.rows = 3; // Set the number of visible rows
        commentTextArea.cols = 30; // Set the number of visible columns
        commentTextArea.placeholder = 'Comments for this product:';
        commentTextArea.value = item.comment || ''; // Load existing comment if available
        commentSection.appendChild(commentTextArea);

        itemContainer.appendChild(commentSection);

        function updateCartItem() {
            item.quantity = parseFloat(quantityInput.value) || 1;
            item.type = quantityUnitSelect.value;
            item.comment = commentTextArea.value; // Save comment

            // Ensure item price is updated based on selected unit type
            const selectedUnit = units.find(unit => unit.value === item.type);
            item.price = selectedUnit ? selectedUnit.price : 0;

            updateTotalPrice(cartItems);
        }

        updateCartItem(); // Calculate initial total price

        quantityUnitSelect.addEventListener('change', updateCartItem);
        quantityInput.addEventListener('input', updateCartItem);
        commentTextArea.addEventListener('input', updateCartItem); // Update when comment changes
    });
}
function generateOrderId(length = 10) {
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let orderId = '';
    for (let i = 0; i < length; i++) {
        const randomIndex = Math.floor(Math.random() * characters.length);
        orderId += characters[randomIndex];
    }
    return orderId;
}
    
                const orderForm = document.createElement('div');
                orderForm.innerHTML = `
                    <h1>Order Details</h1>
                    <div class="form-group">
                        <label for="delivery-address">Delivery Address:</label>
                        <input type="text" id="delivery-address" name="deliveryAddress" required>
                    </div>
                    <div class="form-group">
                        <label for="delivery-date">Name:</label>
                        <input type="text" id="delivery-date" name="deliveryDate" required>
                    </div>
                    <div class="form-group">
                        <label for="contact-info">Contact Info (Phone Number or Telegram Username):</label>
                        <input type="text" id="contact-info" name="contactInfo" required>
                    </div>
                    <!-- New Comment Section -->
                    <div class="form-group">
                        <label for="comments">Comments:</label>
                        <textarea id="comments" name="comments" rows="4" placeholder="Add any additional comments here"></textarea>
                    </div>
                    <div class="form-group">
                        <button id="place-order-button">Check Order</button>

                    </div>
                `;
                section.appendChild(orderForm);
    
                // Add the event listener here
                
            } 
                }
                let orderItems = []; // Array to store order item details

                document.getElementById('place-order-button').addEventListener('click', function() {
    // Collect form data
    var address = document.getElementById('delivery-address').value;
    var date = document.getElementById('delivery-date').value;
    var contact = document.getElementById('contact-info').value;
    var comments = document.getElementById('comments').value;
    
    // Gather item details
    var items = document.querySelectorAll('.item-container');
    var orderItemsHtml = ''; // Initialize or reset the HTML string

    items.forEach(function(item) {
        var productName = item.querySelector('h2').textContent.replace('Product Name: ', '');
        var quantity = item.querySelector('.quantity').value;
        var weightType = item.querySelector('.custom-select').selectedOptions[0].text;
        //var price = item.querySelector('.custom-select').selectedOptions[0].getAttribute('data-price');
     var commentSection = item.querySelector('.comment-section textarea');
        var comment = commentSection ? commentSection.value : ''; // Safeguard if textarea doesn't exist
        
        orderItems.push({
            productName: productName,
            quantity: quantity,
            weightType: weightType,
            comment: comment,
        });

        // Populate the popup with item details
        orderItemsHtml += `
            <div class="order-item">
                <p><strong>Product Name:</strong> ${productName}</p>
                <p><strong>Quantity:</strong> ${quantity}</p>
                <p><strong>Weight Type:</strong> ${weightType}</p>
                <p><strong>Comment:</strong> ${comment}</p>
            </div>
        `;
    });
    var totalPriceElement = document.querySelector('.cart-summary p');
    var totalPrice = totalPriceElement ? totalPriceElement.textContent.trim() : '';   
    const randomId = generateOrderId(12); // You can specify the desired length here
    document.getElementById('popup-address').textContent = address;
    document.getElementById('subtotal').textContent = totalPrice;
    document.getElementById('orderId').textContent = randomId;

    document.getElementById('popup-date').textContent = date;
    document.getElementById('popup-contact').textContent = contact;
    document.getElementById('popup-comments').textContent = comments;
    document.getElementById('order-items').innerHTML = orderItemsHtml;

    // Show the popup and overlay
    document.getElementById('order-popup').style.display = 'block';
    document.getElementById('overlay').style.display = 'block';
});

document.getElementById('confirm-order-btn').addEventListener('click', function() {
    alert('Order confirmed!');
    document.getElementById('order-popup').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';

    // Collect data again
    const deliveryAddress = document.getElementById('delivery-address').value;
    const deliveryDate = document.getElementById('delivery-date').value;
    const contactInfo = document.getElementById('contact-info').value;
    const comments = document.getElementById('comments').value;
    const orderIdElement = document.getElementById('orderId');
    const orderId = orderIdElement ? orderIdElement.textContent : '';    // Prepare order data
    const orderData = {
        deliveryAddress: deliveryAddress,
        deliveryDate: deliveryDate,
        contactInfo: contactInfo,
        comments: comments,
        orderId: orderId,// Ensure this matches the structure you expect on the serve
        items: orderItems,
    };

    console.log('Order Data:', orderData); // Debugging: check the order data

    $.ajax({
        url: 'https://realcali.onrender.com/api/place-order',
        method: 'POST',
        data: JSON.stringify(orderData),
        contentType: 'application/json',
        success: function(response) {
            console.log('Order response:', response); // Debugging: check server response
            if (response.success) {
                // Optionally clear inputs or perform another action
            } else {
                alert('Failed to place order.');
            }
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.error('Order submission failed:', textStatus, errorThrown);
            alert('An error occurred. Please try again.');
        }
    });
});

        document.getElementById('overlay').addEventListener('click', function() {
            document.getElementById('order-popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        });
    });
    </script>
        
        
        
        
        
        
    
    
    
</body>
</html>
