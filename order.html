<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Order Details</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.0/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sometype+Mono:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">
    <style>
        .chakra-input.css-dni0pk {
            font-family: "Sometype Mono", monospace;
            font-optical-sizing: auto;
            font-weight: 400;
            font-style: normal;
            font-size: 17px; /* Adjust the font size if needed */
        }
        
        .body { 
            height: 100vh;
        }
        .needed {
            height: 1000px;
        }
    </style>
</head>
<body class="needed">
    <nav class="navbar">
        <!-- Logo linked to index.html -->
        <a href="index.html" class="logo">
            <img src="realcalilogo copy.png" alt="Logo">
        </a>
        <!-- Text logo, if needed -->
        <div class="logotext">
            <img src="logotextreal.png" alt="Logo Text">
        </div>
    </nav>
    
    <div class="sections">
        <div class="section-block">
            <div class="container">
                <div class="back-button">
                    <a href="javascript:history.back()">
                        &#9664; Back
                    </a>
                </div>
    
                <div id="product-name"></div>
                
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.0/mapbox-gl.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script>document.addEventListener('DOMContentLoaded', function() {
function getUrlParameter(name) {
    name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
    const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    const results = regex.exec(location.search);
    return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' ')) || '';
}

    
function getCartItemsFromUrl() {
        const items = [];
        let index = 0;
        while (true) {
            const itemId = getUrlParameter(`id-${index}`);
            if (!itemId) break; // Exit loop if no more items

            const pricePerGram = parseFloat(getUrlParameter(`pricePerGram-${index}`)) || 0;

            // Check if the type is grams and price per gram is 0
            const type = (getUrlParameter(`type-${index}`) === 'grams' && pricePerGram === 0) ? 'piece' : getUrlParameter(`type-${index}`);

            items.push({
                id: itemId,
                quantity: parseInt(getUrlParameter(`quantity-${index}`), 10) || 1,
                type: type,
                pricePerGram: pricePerGram,
                pricePerOz: parseFloat(getUrlParameter(`pricePerOz-${index}`)) || 0,
                pricePerQp: parseFloat(getUrlParameter(`pricePerQp-${index}`)) || 0,
                pricePerHalfP: parseFloat(getUrlParameter(`pricePerHalfP-${index}`)) || 0,
                pricePer1Lb: parseFloat(getUrlParameter(`pricePer1Lb-${index}`)) || 0,
                description: getUrlParameter(`description-${index}`),
                price: getUrlParameter(`price-${index}`),
                name: getUrlParameter(`name-${index}`)

            });
            index++;
        }
        return items;
    }

    function calculateTotalPrice(cartItems) {
        let totalPrice = 0;

        cartItems.forEach(item => {
            let pricePerUnit;

            // Use item.price if item type is piece
            if (item.type === 'piece') {
                pricePerUnit = parseFloat(item.price) || 0;
            } else {
                // Determine the price per unit based on item type
                switch (item.type) {
                    case 'grams':
                        pricePerUnit = parseFloat(item.pricePerGram) || 0;
                        break;
                    case 'oz':
                        pricePerUnit = parseFloat(item.pricePerOz) || 0;
                        break;
                    case 'qp':
                        pricePerUnit = parseFloat(item.pricePerQp) || 0;
                        break;
                    case 'half-pound':
                        pricePerUnit = parseFloat(item.pricePerHalfP) || 0;
                        break;
                    case 'lbs':
                        pricePerUnit = parseFloat(item.pricePer1Lb) || 0;
                        break;
                    default:
                        pricePerUnit = 0;
                }
            }

            // Accumulate the total price
            totalPrice += pricePerUnit * item.quantity;
        });

        return totalPrice;
    }
function updateTotalPrice(cartItems) {
            const totalPrice = calculateTotalPrice(cartItems);
            document.getElementById('total-price').textContent = `Total Price: $${totalPrice.toFixed(2)}`;
        }
    
        const isCartPage = location.search.includes('id-');
        const isSingleProductPage = location.search.includes('productDescription');
    
        if (isCartPage) {
    const cartItems = getCartItemsFromUrl();
    const section = document.querySelector('.section-block');

    if (isCartPage) {
    const cartItems = getCartItemsFromUrl();
    const section = document.querySelector('.section-block');

    if (cartItems.length > 0) {
        const cartSummary = document.createElement('div');
        cartSummary.classList.add('cart-summary');
        section.appendChild(cartSummary);

        const totalPriceElement = document.createElement('p');
        totalPriceElement.id = 'total-price';
        cartSummary.appendChild(totalPriceElement);

        cartItems.forEach((item, index) => {
            const itemContainer = document.createElement('div');
            itemContainer.classList.add('item-container');
            section.appendChild(itemContainer);

            const itemTitle = document.createElement('h2');
            itemTitle.textContent = `Product Name: ${item.name}`;
            itemContainer.appendChild(itemTitle);

            const itemDescription = document.createElement('p');
            itemDescription.textContent = `Description: ${item.description}`;
            itemContainer.appendChild(itemDescription);

            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.value = item.quantity;
            itemContainer.appendChild(quantityInput);

            const quantityUnitSelect = document.createElement('select');
            quantityUnitSelect.classList.add('custom-select');
            const units = [
                { value: 'grams', text: `Grams - $${item.pricePerGram.toFixed(2)}`, price: item.pricePerGram },
                { value: 'oz', text: `Ounces (oz) - $${item.pricePerOz.toFixed(2)}`, price: item.pricePerOz },
                { value: 'qp', text: `Quarter Pound (QP) - $${item.pricePerQp.toFixed(2)}`, price: item.pricePerQp },
                { value: 'half-pound', text: `Half Pound - $${item.pricePerHalfP.toFixed(2)}`, price: item.pricePerHalfP },
                { value: 'lbs', text: `Pounds (lbs) - $${item.pricePer1Lb.toFixed(2)}`, price: item.pricePer1Lb },
                { value: 'piece', text: `Piece - $${item.price}`, price: item.price }
            ];

            units.forEach(unit => {
                // Only add options for units with a non-zero price or if it is the default type
                if (unit.price > 0 || unit.value === item.type) {
                    const option = document.createElement('option');
                    option.value = unit.value;
                    option.textContent = unit.text;
                    quantityUnitSelect.appendChild(option);
                }
            });

            // Determine default value
            let defaultValue = item.type;

            // Check if the item type exists in the units array and get its price
            const selectedUnit = units.find(unit => unit.value === item.type);
            console.log(item.type)
            if (item.type === 'unknown' ){
                defaultValue = 'piece';
            }

            quantityUnitSelect.value = defaultValue;

            itemContainer.appendChild(quantityUnitSelect);

            function updateCartItem() {
                item.quantity = parseFloat(quantityInput.value) || 1;
                item.type = quantityUnitSelect.value;

                // Ensure item price is updated based on selected unit type
                const selectedUnit = units.find(unit => unit.value === item.type);
                item.price = selectedUnit ? selectedUnit.price : 0;

                updateTotalPrice(cartItems);
            }

            updateCartItem(); // Calculate initial total price

            quantityUnitSelect.addEventListener('change', updateCartItem);
            quantityInput.addEventListener('input', updateCartItem);
        });
    }

    
    
                const orderForm = document.createElement('div');
                orderForm.innerHTML = `
                    <h1>Order Details</h1>
                    <div class="form-group">
                        <label for="delivery-address">Delivery Address:</label>
                        <input type="text" id="delivery-address" name="deliveryAddress" required>
                    </div>
                    <div class="form-group">
                        <label for="delivery-date">Delivery Date:</label>
                        <input type="text" id="delivery-date" name="deliveryDate" required>
                    </div>
                    <div class="form-group">
                        <label for="contact-info">Contact Info (Phone Number or Telegram Username):</label>
                        <input type="text" id="contact-info" name="contactInfo" required>
                    </div>
                    <!-- New Comment Section -->
                    <div class="form-group">
                        <label for="comments">Comments:</label>
                        <textarea id="comments" name="comments" rows="4" placeholder="Add any additional comments here"></textarea>
                    </div>
                    <div class="form-group">
                        <button id="place-order-button" class="submit-button">Place Order</button>
                    </div>
                `;
                section.appendChild(orderForm);
    
                // Add the event listener here
                const placeOrderButton = document.getElementById('place-order-button');
                if (placeOrderButton) {
                    placeOrderButton.addEventListener('click', function() {
    const deliveryAddress = document.getElementById('delivery-address').value;
    const deliveryDate = document.getElementById('delivery-date').value;
    const contactInfo = document.getElementById('contact-info').value;
    const comments = document.getElementById('comments').value;

    const orderData = {
        deliveryAddress: deliveryAddress,
        deliveryDate: deliveryDate,
        contactInfo: contactInfo,
        comments: comments,
        items: cartItems
    };

    console.log('Order Data:', orderData); // Debugging: check the order data

    $.ajax({
        url: 'https://realcali.onrender.com/api/place-order',
        method: 'POST',
        data: JSON.stringify(orderData),
        contentType: 'application/json',
        success: function(response) {
            console.log('Order response:', response); // Debugging: check server response
            if (response.success) {
                alert('Order placed successfully!');
                // Optionally clear inputs or perform another action
            } else {
                alert('Failed to place order.');
            }
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.error('Order submission failed:', textStatus, errorThrown);
            alert('An error occurred. Please try again.');
        }
    });
});
                }
            } else if (isSingleProductPage) {
                const productId = getUrlParameter('productId');
                
                const productName = getUrlParameter('name');
                const productDescription = getUrlParameter('productDescription');
                const productPrice = parseFloat(getUrlParameter('productPrice'));
                const perGram = parseFloat(getUrlParameter('perg'));
                const perOz = parseFloat(getUrlParameter('peroz'));
                const perQp = parseFloat(getUrlParameter('perqp'));
                const perHalfP = parseFloat(getUrlParameter('perhp'));
                const perLb = parseFloat(getUrlParameter('perlb'));
                console.log({ productId, productName, productDescription, productPrice, perGram, perOz, perQp, perHalfP, perLb });

                const section = document.querySelector('.section-block');
    
                const productSummary = document.createElement('div');
                productSummary.classList.add('product-summary');
                section.appendChild(productSummary);
    
                const title = document.createElement('h2');
                title.textContent = `Product ID: ${productId}`;
                productSummary.appendChild(title);
    
                const description = document.createElement('p');
                description.textContent = `Description: ${productDescription}`;
                productSummary.appendChild(description);
    
                const priceElement = document.createElement('p');
                priceElement.textContent = `Price: $${productPrice.toFixed(2)}`;
                productSummary.appendChild(priceElement);
    
                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.value = 1;
                quantityInput.min = 1;
                productSummary.appendChild(quantityInput);
    
                const quantityUnitSelect = document.createElement('select');
                quantityUnitSelect.classList.add('custom-select');
                const units = [
                    { value: 'grams', text: `Grams - $${perGram.toFixed(2)}`, price: perGram },
                    { value: 'oz', text: `Ounces (oz) - $${perOz.toFixed(2)}`, price: perOz },
                    { value: 'qp', text: `Quarter Pound (QP) - $${perQp.toFixed(2)}`, price: perQp },
                    { value: 'half-pound', text: `Half Pound - $${perHalfP.toFixed(2)}`, price: perHalfP },
                    { value: 'lbs', text: `Pounds (lbs) - $${perLb.toFixed(2)}`, price: perLb }
                ];
    
                units.forEach(unit => {
                    if (unit.price > 0) {
                        const option = document.createElement('option');
                        option.value = unit.value;
                        option.textContent = unit.text;
                        quantityUnitSelect.appendChild(option);
                    }
                });
                quantityUnitSelect.value = 'grams'; // Set default unit to grams
                productSummary.appendChild(quantityUnitSelect);
    
                function updateTotalPrice() {
                    const quantity = parseFloat(quantityInput.value) || 1;
                    const unit = quantityUnitSelect.value;
                    const pricePerUnit = units.find(u => u.value === unit).price || 0;
                    priceElement.textContent = `Total Price: $${(quantity * pricePerUnit).toFixed(2)}`;
                }
    
                updateTotalPrice(); // Calculate initial total price
    
                quantityInput.addEventListener('input', updateTotalPrice);
                quantityUnitSelect.addEventListener('change', updateTotalPrice);
    
                const orderForm = document.createElement('div');
                orderForm.innerHTML = `
                    <h1>Order Details</h1>
                    <div class="form-group">
                        <label for="delivery-address">Delivery Address:</label>
                        <input type="text" id="delivery-address" name="deliveryAddress" required>
                    </div>
                    <div class="form-group">
                        <label for="delivery-date">Delivery Date:</label>
                        <input type="text" id="delivery-date" name="deliveryDate" required>
                    </div>
                    <div class="form-group">
                        <label for="contact-info">Contact Info (Phone Number or Telegram Username):</label>
                        <input type="text" id="contact-info" name="contactInfo" required>
                    </div>
                    <!-- New Comment Section -->
                    <div class="form-group">
                        <label for="comments">Comments:</label>
                        <textarea id="comments" name="comments" rows="4" placeholder="Add any additional comments here"></textarea>
                    </div>
                    <div class="form-group">
                        <button id="place-order-button" class="submit-button">Place Order</button>
                    </div>
                `;
                section.appendChild(orderForm);
    
                // Add the event listener here
                const placeOrderButton = document.getElementById('place-order-button');
                if (placeOrderButton) {
                    placeOrderButton.addEventListener('click', function() {
    const deliveryAddress = document.getElementById('delivery-address').value;
    const deliveryDate = document.getElementById('delivery-date').value;
    const contactInfo = document.getElementById('contact-info').value;
    const comments = document.getElementById('comments').value;

    const orderData = {
        deliveryAddress: deliveryAddress,
        deliveryDate: deliveryDate,
        contactInfo: contactInfo,
        comments: comments,
        items: cartItems
    };

    console.log('Order Data:', orderData); // Debugging: check the order data

    $.ajax({
        url: 'https://realcali.onrender.com/api/place-order',
        method: 'POST',
        data: JSON.stringify(orderData),
        contentType: 'application/json',
        success: function(response) {
            console.log('Order response:', response); // Debugging: check server response
            if (response.success) {
                alert('Order placed successfully!');
                // Optionally clear inputs or perform another action
            } else {
                alert('Failed to place order.');
            }
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.error('Order submission failed:', textStatus, errorThrown);
            alert('An error occurred. Please try again.');
        }
    });
});
                }
            }
        }
    });
    </script>
        
        
        
        
        
        
    
    
    
</body>
</html>
